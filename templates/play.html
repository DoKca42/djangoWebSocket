<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Play</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/room.css' %}">
<style>
br{
    line-height: 2rem;
  height: 2rem;
}

html, body{
    margin: 0px;
    width: 100%;
    height: 100%;
    
}

body{
    overflow-x: hidden;
}
header{
    width: 100%;
    display: flex;
    justify-content: center;
}

.unselectable {
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.play-page {
    margin: 0px;
    width: 100%;
    height: 100%;
    background: #9e9191;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.css-selector {
    /*background: linear-gradient(29deg, #0f006f, #c17c27);*/
    background: linear-gradient(29deg, #38527C, #A34B9A);
    background-size: 400% 400%;

    -webkit-animation: AnimationName 13s ease infinite;
    -moz-animation: AnimationName 13s ease infinite;
    -o-animation: AnimationName 13s ease infinite;
    animation: AnimationName 13s ease infinite;
}

@-webkit-keyframes AnimationName {
    0%{background-position:0% 81%}
    50%{background-position:100% 20%}
    100%{background-position:0% 81%}
}
@-moz-keyframes AnimationName {
    0%{background-position:0% 81%}
    50%{background-position:100% 20%}
    100%{background-position:0% 81%}
}
@-o-keyframes AnimationName {
    0%{background-position:0% 81%}
    50%{background-position:100% 20%}
    100%{background-position:0% 81%}
}
@keyframes AnimationName {
    0%{background-position:0% 81%}
    50%{background-position:100% 20%}
    100%{background-position:0% 81%}
}

.play-page-main-box {
    width: fit-content;
    height: fit-content;
    padding: 15px 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 20;
}

.play-page-canvas {
    width: 650px;
    height: 320px;
    border-radius: 10px;
    background: black;
    /*box-shadow: rgba(255, 255, 255, 0.1) 0px 1px 1px 0px inset, rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px;*/
    box-shadow: rgba(201, 46, 70, 0.1) 0px 1px 1px 0px inset, rgba(201, 46, 70, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px;
    display: flex;
}

.play-page-buttons-box {
    width: 100%;
    margin-top: 50px;
    display: flex;
    justify-content: space-around;
}

.play-page-button {
    padding: 10px 15px;
    border-radius: 10px;
    background: #f2e0a8;
    display: flex;
    cursor: pointer;
    font-weight: bold;
}


button {
  padding: 17px 40px;
  border-radius: 10px;
  border: 0;
  background-color: rgb(255, 56, 86);
  letter-spacing: 1.5px;
  font-size: 15px;
  transition: all 0.3s ease;
  box-shadow: rgb(201, 46, 70) 0px 10px 0px 0px;
  color: hsl(0, 0%, 100%);
  cursor: pointer;
}

button:hover {
  box-shadow: rgb(201, 46, 70) 0px 7px 0px 0px;
}

button:active {
  background-color: rgb(255, 56, 86);
  box-shadow: rgb(201, 46, 70) 0px 0px 0px 0px;
  transform: translateY(5px);
  transition: 200ms;
}

.loader {
    border: 4px solid #ff38565e;
    border-radius: 50%;
    border-top: 4px solid #ff3856;
    width: 15px;
    height: 15px;
    -webkit-animation: spin 2s linear infinite; /* Safari */
    animation: spin 2s linear infinite;
}

/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.play-page-queue-box {
    margin-top: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

.play-page-queue-searching {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    margin-bottom: 15px;
    width: 200px;
}

.play-page-queue-title {
    color: rgb(255, 56, 86);
    font-size: 22px;
    font-weight: 500;
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
    text-shadow: 3px 4px 7px rgb(255 56 86 / 30%);
}

.play-page-queue-waiting {
    color: rgb(255, 56, 86);
    font-size: 15.5px;
    font-weight: 500;
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
    text-shadow: 3px 4px 7px rgb(255 56 86 / 30%);
    margin-bottom: 3px;
}
.play-page-queue-waiting-value {
    color: black;
    font-weight: 400;
}

.particles-js-canvas-el {
    position: absolute;
    opacity: 47%;
    z-index: 10;
}

</style>
</head>
<body>

<content class="play-page css-selector" id="particles-js">
    <div class="play-page-main-box">
        <canvas class="play-page-canvas" id="play_page_canvas"></canvas>
        <div class="play-page-buttons-box unselectable" id="play_page_buttons">
            <button onclick="joinMatch()" id="play_page_join_match_button">Join Match</button>
            <button onclick="joinTour()" id="play_page_join_tour_button">Join Tournament</button>
        </div>
        <div class="play-page-queue-box unselectable" id="play_page_queue" style="display: none">
            <div class="play-page-queue-searching" id="play_page_queue_buttons">
                <span class="play-page-queue-title" id="play_page_queue_title">None</span>
                <div class="loader"></div>
            </div>
            <span class="play-page-queue-waiting">Waiting:&ensp;
                <span class="play-page-queue-waiting-value" id="play_page_queue_waiting">00:00</span></span>
            <span class="play-page-queue-waiting">IA game after
                <span class="play-page-queue-waiting-value" id="play_page_queue_waiting">30s</span></span>
            <button onclick="cancelMM()" id="play_page_join_match_button" style="margin-top:10px">Cancel</button>
        </div>
    </div>
</content>

<script src="particles.js"></script>
<script type="text/javascript">
let waiting_time = 0;
var waitingInterval = 0;

function join(type)
{
    document.getElementById("play_page_buttons").style.display = "none";
    document.getElementById("play_page_queue").style.display = "flex";

    if (type === "match")
    {
        document.getElementById("play_page_queue_buttons").style.width = "200px";
        document.getElementById("play_page_queue_title").innerHTML = "Searching match";
    }
    else
    {
        document.getElementById("play_page_queue_buttons").style.width = "260px";
        document.getElementById("play_page_queue_title").innerHTML = "Searching tournament";
    }
    waiting_time = 0;
    document.getElementById("play_page_queue_waiting").innerHTML = "00:00";
    waitingInterval = setInterval(waitingTime, 1000);

}

function joinMatch()
{
    join("match");
}

function joinTour()
{
    join("tournament");
}



function cancelMM()
{
    document.getElementById("play_page_buttons").style.display = "flex";
    document.getElementById("play_page_queue").style.display = "none";
    clearInterval(waitingInterval);
    waiting_time = 0;
}



function digitNumber(number)
{
    return number < 10 ? '0' + number : '' + number;
}

function getUnixTime()
{
    let date = new Date();

    let offsetParis = 60;
    let offsetCurrentTimezone = date.getTimezoneOffset();
    let offsetTotal = offsetCurrentTimezone + offsetParis; 
    date.setMinutes(date.getMinutes() + offsetTotal);
    let unixTimeUTCParis = date.getTime() / 1000;
    return (unixTimeUTCParis)
}

function waitingTime()
{
    const d = new Date();

    waiting_time += 1
    let minutes = Math.floor(waiting_time / 60);
    let secondes = waiting_time % 60;

    document.getElementById("play_page_queue_waiting").innerHTML = digitNumber(minutes)+":"+digitNumber(secondes);
}



//ratio 2.03125
// 0.4923076923
//1300 -> 650

let resolution = 2;
let width = 650;
let height = 320;

document.getElementById("play_page_canvas").style.width = window.innerWidth * 0.5+"px";
document.getElementById("play_page_canvas").style.height = (window.innerWidth * 0.5) * 0.4923076923+"px";

addEventListener("resize", (event) => {
    document.getElementById("play_page_canvas").style.width = window.innerWidth * 0.5+"px";
    document.getElementById("play_page_canvas").style.height = (window.innerWidth * 0.5) * 0.4923076923+"px";
});



let play_pong_animation = true;

let pose_a = 100;
let pose_b = 420;
let paddle_height = 65 * resolution;
let ball_pose = {x:0, y: 0, direction: 0, velocity: 0};

function degreesToRadians(degrees)
{
    return degrees * Math.PI / 180;
}

function moveProtection(input, height_line)
{
    if (input <= 0)
        return (0);
    if (input + height_line >= height * 2)
        return (height * 2 - height_line);
    return (input);
}

function reverseDirection(direction)
{
    let reversedDirection = direction - 180;

    reversedDirection += Math.random() * 20 - 10;

    if (reversedDirection < 0)
        reversedDirection += 360;
    else if (reversedDirection >= 360)
        reversedDirection -= 360;
    return reversedDirection;
}

function handleVerticalCollision(direction)
{
    return 360 - direction;
}


function checkCollisions()
{
    let ball_radius = 4;

    if (ball_pose.y <= 0)
    {
        ball_pose.direction = handleVerticalCollision(ball_pose.direction);
    }

    if (ball_pose.y >= height * resolution)
    {
        ball_pose.direction = handleVerticalCollision(ball_pose.direction);
    }

    if (ball_pose.x - ball_radius < 58 && ball_pose.y > pose_a && ball_pose.y < pose_a + paddle_height)
    {
        ball_pose.direction = reverseDirection(ball_pose.direction);
        ball_pose.velocity += 1;
    }
    
    if (ball_pose.x + ball_radius > width * resolution - 58 && ball_pose.y > pose_b && ball_pose.y < pose_b + paddle_height)
    {
       ball_pose.direction = reverseDirection(ball_pose.direction);
       ball_pose.velocity += 1;
    }
}

function movePadle(pose, height_line, excepeted)
{
    let speed = 4;

    if (excepeted >= pose + 20 && excepeted <= (pose + height_line) - 20)
        return (0);
    pose = pose + (paddle_height / 2);
    if (pose < excepeted)
        return (speed);
    if (pose > excepeted)
        return (-speed);
}

function playPongAnimation()
{
    if (ball_pose.x < 20 || ball_pose.x  > cwidth - 20)
    {
        centerPong();
    }
    ctx.clearRect(0, 0, width * resolution, height * resolution);

    if (ball_pose.direction >= 90 && ball_pose.direction <= 270)
    {
        pose_a += movePadle(pose_a, paddle_height, ball_pose.y);
        pose_a = moveProtection(pose_a, paddle_height);
    }
    else
    {
        
        pose_b += movePadle(pose_b, paddle_height, ball_pose.y);
        pose_b = moveProtection(pose_b, paddle_height);
    }
    checkCollisions();
    ball_pose.x += ball_pose.velocity * Math.cos(degreesToRadians(ball_pose.direction));
    ball_pose.y += ball_pose.velocity * Math.sin(degreesToRadians(ball_pose.direction));


    Drawarc(ctx, ball_pose.x, ball_pose.y, 10, 0, Math.PI * 2, 4, "white", true);
    Drawrect(ctx, 50, pose_a, 8, paddle_height, 9, "white");
    Drawrect(ctx, cwidth - 50, pose_b, 8, paddle_height, 9, "white");
    if (play_pong_animation)
        window.requestAnimationFrame(playPongAnimation);
}



function generateRandomStartAngle() {
    const random = Math.random();
    
    let angle;
    if (random < 0.5) {
        angle = Math.random() < 0.5 ? Math.floor(Math.random() * 26) : Math.floor(Math.random() * 26) + 335;
    } else {
        angle = Math.floor(Math.random() * 51) + 155;
    }
    
    return angle;
}

function centerPong()
{
    let start_angle = generateRandomStartAngle();
    
    ball_pose = {x:width, y:height, direction: start_angle, velocity: 10};
    pose_a = (height * resolution) / 2 - (paddle_height / 2);
    pose_b = (height * resolution) / 2 - (paddle_height / 2);
}


centerPong();

window.requestAnimationFrame(playPongAnimation);


let canvas = document.getElementById("play_page_canvas");
let ctx = canvas.getContext("2d");

let cwidth = width * resolution;
let cheight = height * resolution;

canvas.width = cwidth;
canvas.height = cheight;

/* ==================== CANVAS ==================== */

function Drawline(ctx, x1, y1, x2, y2, width, color)
{
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
}

function Drawarc(ctx, x, y, diametre, start, end, width, color, fill=false)
{
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.arc(x, y, diametre, start, end);
    if (fill) {
        ctx.fillStyle = color;
        ctx.fill();
    } else {
        ctx.stroke();
    }
}

function Drawrect(ctx, x, y, width, height, width_line, color)
{
    ctx.strokeStyle = color;
    ctx.lineWidth = width_line;
    ctx.beginPath();
    ctx.rect(x, y, width, height);
    ctx.stroke();
}

function WriteText(ctx, text, x, y, align, color)
{
    ctx.font = "65px Inter, Helvetica, Arial, sans-serif";
    ctx.fillStyle = color;
    ctx.textAlign = align;

    ctx.fillText(text, x, y);
}

function WriteTitle(ctx, text, x, y, align, color, size)
{
    ctx.font = size+"px Inter, Helvetica, Arial, sans-serif";
    ctx.fillStyle = color;
    ctx.textAlign = align;

    ctx.fillText(text, x, y);
}
</script>
<script type="text/javascript">
particlesJS('particles-js',
  
  {
    "particles": {
      "number": {
        "value": 80,
        "density": {
          "enable": true,
          "value_area": 800
        }
      },
      "color": {
        "value": "#ffffff"
      },
      "shape": {
        "type": "circle",
        "stroke": {
          "width": 0,
          "color": "#000000"
        },
        "polygon": {
          "nb_sides": 5
        },
        "image": {
          "src": "img/github.svg",
          "width": 100,
          "height": 100
        }
      },
      "opacity": {
        "value": 0.5,
        "random": false,
        "anim": {
          "enable": false,
          "speed": 1,
          "opacity_min": 0.1,
          "sync": false
        }
      },
      "size": {
        "value": 5,
        "random": true,
        "anim": {
          "enable": false,
          "speed": 40,
          "size_min": 0.1,
          "sync": false
        }
      },
      "line_linked": {
        "enable": true,
        "distance": 150,
        "color": "#ffffff",
        "opacity": 0.4,
        "width": 1
      },
      "move": {
        "enable": true,
        "speed": 6,
        "direction": "none",
        "random": false,
        "straight": false,
        "out_mode": "out",
        "attract": {
          "enable": false,
          "rotateX": 600,
          "rotateY": 1200
        }
      }
    },
    "interactivity": {
      "detect_on": "canvas",
      "events": {
        "onhover": {
          "enable": true,
          "mode": "repulse"
        },
        "onclick": {
          "enable": true,
          "mode": "push"
        },
        "resize": true
      },
      "modes": {
        "grab": {
          "distance": 400,
          "line_linked": {
            "opacity": 1
          }
        },
        "bubble": {
          "distance": 400,
          "size": 40,
          "duration": 2,
          "opacity": 8,
          "speed": 3
        },
        "repulse": {
          "distance": 200
        },
        "push": {
          "particles_nb": 4
        },
        "remove": {
          "particles_nb": 2
        }
      }
    },
    "retina_detect": true,
    "config_demo": {
      "hide_card": false,
      "background_color": "#b61924",
      "background_image": "",
      "background_position": "50% 50%",
      "background_repeat": "no-repeat",
      "background_size": "cover"
    }
  }

);
</script>
</body>
</html>